<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally API Query Translator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css">
    <style>
        /* Custom styles to refine Pico for this app's specific needs and match original intent */
        body {
            /* Pico handles general body styling, adding padding based on viewport */
            /* We only ensure min-height for full screen appearance */
            min-height: 100vh;
        }

        /* Centering the main content, Pico's .container does this mostly */
        main.container {
            padding-top: 2rem; /* Adjusted for better spacing from the top */
            padding-bottom: 2rem;
            max-width: 56rem; /* Equivalent to original max-w-4xl */
        }

        /* Header styles */
        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            color: var(--pico-heading-color); /* Using the new Stand-Out Slate for headings */
            font-size: 2.25rem; /* ~sm:text-4xl */
            line-height: 2.5rem;
            font-weight: 700; /* font-bold */
            margin-bottom: 0.5rem; /* mt-2 from original, applied to p below */
        }

        header p {
            color: var(--pico-muted-color); /* text-slate-400, can remain muted */
            margin-top: 0; /* Override Pico's default paragraph margin if needed */
        }
        @media (min-width: 640px) { /* sm breakpoint for responsive text */
            header h1 {
                font-size: 2.5rem;
            }
        }

        /* Card styles (main input and result cards) */
        article {
            background-color: var(--pico-card-background); /* Lighter background for cards */
            border-color: var(--pico-border-color); /* Use Pico's border color */
            border-width: 1px;
            border-style: solid;
            border-radius: var(--pico-border-radius); /* Use Pico's default rounding */
            box-shadow: var(--pico-shadow-2); /* Pico's default shadow */
            padding: 1.5rem; /* Pico's default padding - Unified padding */
            margin-bottom: 1.5rem; /* space-y-6 equivalent, adjusted for articles */
        }


        label {
            color: var(--pico-heading-color); /* Match headings with Stand-Out Slate */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.75rem; /* mb-3 */
            display: block;
        }

        textarea {
            background-color: var(--pico-textarea-background); /* A darker slate for textareas */
            border-color: var(--pico-heading-color); /* border-slate-600 */
            border-radius: var(--pico-border-radius); /* rounded-md */
            padding: 0.75rem; /* p-3 */
            font-size: 0.875rem; /* text-sm */
            font-family: var(--pico-font-family-monospace); /* font-mono */
            color: var(--pico-color); /* Ensure text is visible */
            height: 7rem; /* h-28 */
            width: 100%; /* w-full */
            box-shadow: none; /* Remove default textarea shadow if any */
            transition: box-shadow 150ms ease-in-out; /* transition-shadow */
        }
        textarea:focus {
            outline: 2px solid var(--pico-primary); /* Focus ring with primary green */
            outline-offset: 2px;
            border-color: var(--pico-primary);
            box-shadow: 0 0 0 2px var(--pico-primary);
        }

        /* Flexbox and gap for buttons row */
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem; /* mt-4 */
            gap: 1rem; /* gap-4 */
        }
        .flex-container > div {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem; /* gap-2 */
        }

        /* Test case buttons */
        .test-case-btn {
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            font-size: 0.75rem; /* text-xs */
            background-color: var(--pico-textarea-background); /* Use the stand-out slate for these */
            color: var(--pico-p); /* White text for contrast */
            border-radius: 9999px; /* rounded-full */
            transition: background-color 150ms ease-in-out, color 150ms ease-in-out; /* transition-colors */
            border: 1px solid var(--pico-textarea-background);
            border-color: var(--pico-heading-color);
            cursor: pointer;
        }
        .test-case-btn:hover {
            background-color: var(--pico-secondary-hover); /* A slightly darker slate on hover */
        }

        /* Translate button */
        #translate-button {
            background-color: var(--pico-primary-background); /* Primary Action Green */
            color: var(--pico-primary-inverse); /* text-white */
            font-weight: 700; /* font-bold */
            padding: 0.5rem 1.5rem; /* py-2 px-6 */
            border-radius: var(--pico-border-radius); /* rounded-lg */
            transition: transform 150ms ease-in-out, background-color 150ms ease-in-out; /* transition-transform */
            transform: scale(1); /* Base transform */
            box-shadow: var(--pico-shadow-1); /* shadow-md */
            width: 100%; /* w-full */
        }
        #translate-button:hover {
            background-color: var(--pico-primary-hover); /* Darker green on hover */
            transform: scale(1.05); /* hover-scale-105 */
        }
        @media (min-width: 640px) { /* sm:w-auto */
            #translate-button {
                width: auto;
            }
        }


        /* Error message */
        .hidden { display: none; }
        #error-message {
            margin-top: 1.5rem; /* mt-6 */
            background-color: var(--pico-error-background); /* Custom red for error */
            border: 1px solid var(--pico-error-border); /* Darker red border */
            color: var(--pico-error-color); /* Lighter red text */
            padding: 0.75rem 1rem; /* px-4 py-3 */
            border-radius: var(--pico-border-radius); /* rounded-lg */
            font-size: 0.875rem; /* text-sm */
        }
        #error-message strong {
            font-weight: 700; /* font-bold */
        }
        #error-message span {
            display: block;
            margin-left: 0.5rem; /* ml-2 */
        }
        @media (min-width: 640px) { /* sm:inline */
            #error-message span {
                display: inline;
            }
        }


        /* Results container spacing */
        #results-container {
            margin-top: 2rem; /* mt-8 */
        }
        #results-container article:not(:first-child) {
            margin-top: 1.5rem; /* space-y-6 */
        }
        /* Debugging: This rule applied to articles inside debugging-details-content.
           It's now effectively commented out with the debugging HTML. */
        /* .debugging-details-content article:not(:first-child) {
            margin-top: 1rem;
        } */

        /* Debugging: Styles for the details/summary element, now commented out with HTML. */
        /* details {
            border-color: var(--pico-border-color);
            border-width: 1px;
            border-style: solid;
            border-radius: var(--pico-border-radius);
            transition: all 150ms ease-in-out;
            margin-bottom: 1.5rem;
        }
        summary {
            color: var(--pico-muted-color);
            transition: color 150ms ease-in-out;
            cursor: pointer;
            padding: var(--pico-spacing);
            font-size: 0.875rem;
            font-weight: 500;
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary::before {
            content: 'â–º';
            display: inline-block;
            margin-right: 0.5em;
            transition: transform 0.2s;
        }
        details[open] summary::before {
            transform: rotate(90deg);
        }
        summary:hover {
            color: var(--pico-color);
        }
        .debugging-details-content {
            padding: 0 1rem 1rem;
            padding-top: 0;
        } */

        /* Rally API Query URL title styling (matching the label) */
        article > div.flex-container > label { /* Target the label directly within article > flex-container */
            color: var(--pico-heading-color); /* Matching label color with Stand-Out Slate */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0; /* Override Pico's default h3 margin-bottom */
            margin-top: 0; /* Override Pico's default h3 margin-top */
        }


        /* Debugging: Styles for debugging card headers, now effectively commented out. */
        /* #decoded-query-card h3, #encoded-query-card h3 {
            color: var(--pico-muted-color);
            font-size: 0.875rem;
            font-weight: 500;
            display: block;
        } */

        /* Pre/Code block styles -- MODIFIED to match textarea */
        pre {
            /* --- Styles changed/added to match the textarea --- */
            background-color: var(--pico-textarea-background); /* Matches textarea background */
            border: 1px solid var(--pico-border-color); /* Adds the same border as the textarea */
            padding: 0rem; /* Matches textarea padding */
            font-family: var(--pico-font-family-monospace); /* Matches textarea font */
            color: var(--pico-color); /* Matches textarea text color */
            border-color: var(--pico-heading-color);

            /* --- Unchanged properties below --- */
            border-radius: var(--pico-border-radius);
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 0.5rem;
            overflow: auto;
        }
        pre.h-28 { height: 7rem; } /* h-28 */


        /* Copy button specific styles */
        .copy-button {
            /* Now matching translate button, scaled down */
            background-color: var(--pico-primary-background); /* Use primary color */
            color: var(--pico-primary-inverse); /* White text */
            font-weight: 700; /* Bold */
            padding: 0.3rem 0.8rem; /* Smaller padding than translate button */
            font-size: 0.85rem; /* Slightly smaller font size */
            border-radius: var(--pico-border-radius); /* rounded-md */
            transition: transform 150ms ease-in-out, background-color 150ms ease-in-out; /* transition-transform, transition-colors */
            transform: scale(1); /* Base transform */
            box-shadow: var(--pico-shadow-1); /* shadow-md */
            
            display: flex; /* flex */
            align-items: center; /* items-center */
            gap: 0.35rem; /* gap-2 (slightly adjusted for smaller button) */
            border: none; /* Remove default button border */
            cursor: pointer;
            
            /* Adjust position relative to flex-container */
            margin-top: 0; 
            margin-right: 0;
        }
        .copy-button:hover {
            background-color: var(--pico-primary-hover); /* Hover state */
            transform: scale(1.05); /* Hover scale effect */
        }
        .copy-button svg {
            height: 0.9rem; /* Slightly smaller icons */
            width: 0.9rem; /* Slightly smaller icons */
            stroke: currentColor;
            fill: none;
        }
        .copy-button .copy-icon { display: inline-block; }
        .copy-button .check-icon { display: none; }
        .copy-button.copied {
            background-color: var(--pico-success-background); /* bg-green-600 */
            color: var(--pico-success-inverse); /* text-white */
        }
        .copy-button.copied .copy-icon { display: none; }
        .copy-button.copied .check-icon { display: inline-block; }

        /* Pico custom properties for color consistency with original Tailwind theme */
        :root {
            /* Your provided palette */
            --page-gray-base: #E4E4E4; /* Original page gray for card background */
            --page-gray-darker: #D8D8D8; /* Slightly darker for the main body background */
            --stand-out-slate: #4A5767;
            --primary-action-green: #23826F;
            --primary-action-green-hover: #1f6e5e; /* Slightly darker for hover */

            /* Pico variable mapping */
            --pico-background-color: var(--page-gray-darker); /* Slightly darker background for the body */
            --pico-color: #333333; /* Darker text for readability on light background */
            --pico-muted-color: #6B7280; /* A darker grey for muted text */
            --pico-border-color: #C2C2C2; /* A lighter, slightly darker border */

            --pico-heading-color: var(--stand-out-slate); /* For H1 and labels */
            --pico-card-background: var(--page-gray-base); /* Original page gray for cards */
            --pico-textarea-background: #EFEFEF; /* Light gray for text area background, slightly different from card */

            /* Customizing Pico's primary button colors to match green */
            --pico-primary: var(--primary-action-green); /* For focus outlines */
            --pico-primary-background: var(--primary-action-green);
            --pico-primary-hover: var(--primary-action-green-hover);
            --pico-primary-inverse: #ffffff; /* text-white */
            --pico-primary-active: var(--primary-action-green-hover);

            /* Customizing Pico's secondary button colors to match Stand-Out Slate */
            --pico-secondary-background: var(--stand-out-slate);
            --pico-secondary-hover: #3C4754; /* Slightly darker slate for hover */
            --pico-secondary-color: #ffffff; /* text-white */
            --pico-secondary-active: #3C4754;

            /* Customizing Pico's success/copied state to a brighter green */
            --pico-success-background: #28A745; /* A standard success green */
            --pico-success-inverse: #ffffff;

            /* Customizing Pico's red for error messages */
            --pico-error-background: #FEE2E2; /* Light red background */
            --pico-error-border: #EF4444; /* Brighter red border */
            --pico-error-color: #991B1B; /* Darker red text */

            /* Pico shadow values can remain or be adjusted as needed */
            --pico-shadow-1: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --pico-shadow-2: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

            --pico-white: #FFFFFF; /* Explicit white for use where needed */
        }

        /* Adjusting for data-theme="light" to ensure Pico's light mode is active */
        html[data-theme="dark"] {
            --pico-background-color: var(--page-gray-darker); /* Overrides dark mode background if it somehow gets applied */
            --pico-color: #333333;
        }

        /* Ensure .text-slate-400 for 'Load example' span uses a defined muted color */
        .text-slate-400 {
            color: var(--pico-muted-color);
        }
    </style>
</head>
<body class="p-4">
    <main class="container">
        <header>
            <h1>Rally API Query Translator</h1>
            <p>Paste your Rally UI query to convert it into a valid REST API query string.</p>
        </header>

        <article id="input-card">
            <label for="rally-query">Rally UI Query</label>
            <textarea
                id="rally-query"
                placeholder="e.g. (State = Open) AND (Owner = user@example.com)"
            >((parent.formattedID = PGM519) and (ProductArea = "D-RAD") AND (ProductRoadmapQuarterStatus = "Committed") and (State != Done))</textarea>

            <div class="flex-container">
                <div>
                    <span class="text-sm text-slate-400">Load example:</span>
                    <div id="test-cases-container">
                        </div>
                </div>
                <button id="translate-button">
                    Translate
                </button>
            </div>
        </article>

        <div id="error-message" role="alert" class="hidden">
            <strong>Error:</strong>
            <span id="error-text"></span>
        </div>

        <div id="results-container" class="hidden">
            <article>
                <div class="flex-container">
                    <label>Rally API Query URL</label>
                    <button id="copy-full-url" class="copy-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 copy-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 check-icon hidden" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 13l4 4L19 7" /></svg>
                        <span class="copy-text">Copy</span>
                    </button>
                </div>
                <pre class="h-28 overflow-auto"><code id="full-url-value"></code></pre>
            </article>

            </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const uiQueryInput = document.getElementById('rally-query');
            const translateButton = document.getElementById('translate-button');
            const errorMessageDiv = document.getElementById('error-message');
            const errorTextSpan = document.getElementById('error-text');
            const resultsContainer = document.getElementById('results-container');

            const fullUrlValue = document.getElementById('full-url-value');
            // Debugging: Reference to the decoded query value display element
            const decodedQueryValue = document.getElementById('decoded-query-value');
            // Debugging: Reference to the encoded query value display element
            const encodedQueryValue = document.getElementById('encoded-query-value');

            const copyFullUrlBtn = document.getElementById('copy-full-url');
            // Debugging: Reference to the copy button for the decoded query
            const copyDecodedQueryBtn = document.getElementById('copy-decoded-query');
            // Debugging: Reference to the copy button for the encoded query
            const copyEncodedQueryBtn = document.getElementById('copy-encoded-query');

            const testCasesContainer = document.getElementById('test-cases-container');

            // --- STATE MANAGEMENT (Plain JS variables) ---
            // Initialize uiQuery with the value directly from the textarea on load
            let uiQuery = uiQueryInput.value; 

            // --- TEST CASES ---
            const testCases = {
                "User Reported Query": `((parent.formattedID = PGM519) and (ProductArea = "D-RAD") AND (ProductRoadmapQuarterStatus = "Committed") and (State != Done))`,
                "Complex Mixed Logic": `(((Parent.formattedid = PGM519) OR (Parent.formattedid = PGM815)) AND (tags.name contains "#AWSMasterPRJ") OR ((milestones.ObjectID = 734046831375) OR (milestones.ObjectID = 465069487428)) AND ((c_ProjStatusColor = "Red") OR (c_ProjStatusColor = "Yellow")) AND (State != Done) AND (State != "Obsolete/Not Needed") AND (tags.name !contains "Exclude_RY_Status"))`,
                "Simple Custom Field": `(My Custom Field = "Test Value" and status = In-Progress)`,
                "Nested Parentheses": `((((parent.formattedID = PGM519) AND ((milestones.ObjectID = 734046831375) OR (milestones.ObjectID = 465069487428)) AND (State != "Obsolete/Not Needed")))) OR (parent.formattedID = PGM815))`,
            };

            // --- CORE TRANSLATION LOGIC (Unchanged from React version) ---
            const CONFIRMED_FIELDS = new Set([
                'c_CustomerReferenceWorkOrderCR', 'c_CustomerReqID', 'c_ItemPriority',
                'c_PMOLeader', 'c_ProductArea', 'c_ProductRoadmapBUTEOProduct',
                'c_ProductRoadmapQuarter', 'c_ProductRoadmapQuarterStatus', 'c_ProductSuitePriority',
                'c_ProgramManager', 'c_ProjectProgress', 'c_ProjStatusColor', 'c_TechOwner',
                'c_TEOActionsToGreen', 'c_TEOFunctionalArea', 'c_TEOMajorDeliverable',
                'c_TEORYReason', 'Expedite', 'FormattedID', 'LeafStoryPlanEstimateTotal',
                'Milestones', 'Name', 'Notes', 'Owner', 'Parent', 'PercentDoneByStoryCount',
                'PercentDoneByStoryPlanEstimate', 'PlannedEndDate', 'PlannedStartDate',
                'PreliminaryEstimate', 'State', 'status', 'TEOMajorDeliverable', 'Tags'
            ]);

            const toPascalCase = (str) => {
                if (!str) return '';
                return str.replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1)).replace(/\s/g, '');
            };
            
            const translateRallyQuery = (query) => {
                const rawTokens = query.match(/"[^"]*"|\(|\)|!=|!contains|contains|=|>|<|\bAND\b|\bOR\b|[\w\s.]+/g) || [];
                if (rawTokens.length === 0 && query.trim() !== '') {
                    throw new Error("Could not parse the query. Please check for syntax errors.");
                }

                const tokens = [];
                const operatorsAndParens = new Set(['(', ')', '=', '!=', '>', '<', 'contains', '!contains']);
                rawTokens.forEach(rawToken => {
                    const t = rawToken.trim();
                    if (t === '') return;
                    if (t.length > 1 && t.endsWith(')')) {
                        const partBeforeParen = t.slice(0, -1).trim();
                        if (!operatorsAndParens.has(partBeforeParen.toLowerCase())) {
                            tokens.push(partBeforeParen);
                            tokens.push(')');
                            return;
                        }
                    }
                    tokens.push(t);
                });
                
                const expressions = [];
                const logicalOperators = [];
                const operators = new Set(['=', '!=', '>', '<', 'contains', '!contains']);
                let i = 0;

                while (i < tokens.length) {
                    let token = tokens[i];
                    const lowerToken = token.toLowerCase();

                    if (lowerToken === 'and' || lowerToken === 'or') {
                        if(expressions.length > 0) { 
                            logicalOperators.push(token.toUpperCase());
                        }
                        i++;
                        continue;
                    }

                    if (token === '(') {
                        let balance = 1;
                        let j = i + 1;
                        while (j < tokens.length && balance > 0) {
                            if (tokens[j] === '(') balance++;
                            if (tokens[j] === ')') balance--;
                            j++;
                        }
                        if (balance !== 0) throw new Error("Mismatched parentheses in your query.");
                        
                        const subQuery = tokens.slice(i + 1, j - 1).join(' ');
                        const subTranslation = translateRallyQuery(subQuery);
                        
                        expressions.push(subTranslation.decodedQuery);
                        i = j;
                        continue;
                    }

                    const fieldToken = tokens[i];
                    const operatorToken = tokens[i + 1];
                    const valueToken = tokens[i + 2];

                    if(!fieldToken || !operatorToken || !valueToken || !operators.has(operatorToken.toLowerCase())) {
                        // If a triplet (field, operator, value) isn't found or operator is invalid,
                        // it might be a malformed expression. Skip past the current token to avoid infinite loop.
                        i++; 
                        continue; 
                    }
                    
                    let finalField;
                    if (fieldToken.includes('.')) {
                        const parts = fieldToken.split('.').map(part => {
                           const casedPart = toPascalCase(part);
                           return CONFIRMED_FIELDS.has(casedPart) ? casedPart : part;
                        });
                        finalField = parts.join('.');
                    } else {
                        const pascalCased = toPascalCase(fieldToken);
                        if (CONFIRMED_FIELDS.has(pascalCased)) {
                            finalField = pascalCased;
                        } else {
                            finalField = `c_${pascalCased}`;
                        }
                    }

                    let finalValue = valueToken;
                    // Check if value needs quotes: it's not already quoted, not a number, not true/false
                    if (!finalValue.startsWith('"') && !finalValue.endsWith('"') && !/^\d+$/.test(finalValue) && finalValue.toLowerCase() !== 'true' && finalValue.toLowerCase() !== 'false') {
                       finalValue = `"${finalValue}"`;
                    }
                    
                    expressions.push(`(${finalField} ${operatorToken.toLowerCase()} ${finalValue})`);
                    i += 3;
                }

                if (expressions.length === 0) {
                    return { decodedQuery: '', encodedQuery: '', fullExampleUrl: '' };
                }
                
                if (expressions.length !== logicalOperators.length + 1) {
                    throw new Error(`Invalid query structure. Found ${expressions.length} expressions but ${logicalOperators.length} logical operators. This might be due to malformed expressions or missing operators.`);
                }

                let decodedQuery = expressions[0];
                for (let k = 0; k < logicalOperators.length; k++) {
                    decodedQuery = `(${decodedQuery} ${logicalOperators[k]} ${expressions[k + 1]})`;
                }
                
                const encodedQuery = encodeURIComponent(decodedQuery);
                const fullExampleUrl = `https://rally1.rallydev.com/slm/webservice/v2.0/portfolioitem/ppmproject?query=${encodedQuery}`;

                return { decodedQuery, encodedQuery, fullExampleUrl };
            };


            // --- UI Update Functions ---

            function displayError(message) {
                errorTextSpan.textContent = message;
                errorMessageDiv.classList.remove('hidden');
                resultsContainer.classList.add('hidden'); // Hide results if there's an error
            }

            function hideError() {
                errorMessageDiv.classList.add('hidden');
                errorTextSpan.textContent = '';
            }

            function displayResults(translation) {
                fullUrlValue.textContent = translation.fullExampleUrl;
                // Debugging: Display the decoded query in its dedicated element. Uncomment to re-enable.
                // decodedQueryValue.textContent = translation.decodedQuery;
                // Debugging: Display the URL-encoded query in its dedicated element. Uncomment to re-enable.
                // encodedQueryValue.textContent = translation.encodedQuery;
                resultsContainer.classList.remove('hidden');
            }

            function hideResults() {
                resultsContainer.classList.add('hidden');
                fullUrlValue.textContent = '';
                // Debugging: Clear the decoded query display element. Uncomment to re-enable.
                // decodedQueryValue.textContent = '';
                // Debugging: Clear the encoded query display element. Uncomment to re-enable.
                // encodedQueryValue.textContent = '';
            }

            function setCopyButtonState(buttonElement, isCopied) {
                const copyTextSpan = buttonElement.querySelector('.copy-text');
                const copyIcon = buttonElement.querySelector('.copy-icon');
                const checkIcon = buttonElement.querySelector('.check-icon');

                if (isCopied) {
                    buttonElement.classList.add('copied');
                    copyTextSpan.textContent = 'Copied!';
                    if (copyIcon) copyIcon.classList.add('hidden');
                    if (checkIcon) checkIcon.classList.remove('hidden');
                } else {
                    buttonElement.classList.remove('copied');
                    copyTextSpan.textContent = 'Copy';
                    if (copyIcon) copyIcon.classList.remove('hidden');
                    if (checkIcon) checkIcon.classList.add('hidden');
                }
            }

            // --- EVENT HANDLERS ---

            uiQueryInput.addEventListener('input', (event) => {
                uiQuery = event.target.value;
                hideError(); // Clear error on new input
                hideResults(); // Clear results on new input
            });

            translateButton.addEventListener('click', () => {
                hideError();
                hideResults(); // Ensure results are hidden initially for a new translation

                if (!uiQuery.trim()) {
                    displayError("Query input cannot be empty.");
                    return;
                }

                try {
                    const translation = translateRallyQuery(uiQuery.trim());
                    displayResults(translation);
                } catch (e) {
                    displayError(e.message);
                }
            });

            const handleCopyToClipboard = (text, buttonElement) => {
                // Create a temporary textarea element to copy text
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = 'fixed'; // Prevents scrolling to bottom
                textArea.style.left = '-9999px'; // Move off-screen
                textArea.style.top = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select(); // Select the text in the textarea

                try {
                    document.execCommand('copy'); // Execute copy command
                    setCopyButtonState(buttonElement, true); // Update button UI to "Copied!"
                    // Revert button UI after 2 seconds
                    setTimeout(() => {
                        setCopyButtonState(buttonElement, false);
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    // Optionally, display a user-friendly error message if copy fails
                } finally {
                    document.body.removeChild(textArea); // Clean up the temporary textarea
                }
            };

            // Attach clipboard handlers to each copy button
            copyFullUrlBtn.addEventListener('click', () => handleCopyToClipboard(fullUrlValue.textContent, copyFullUrlBtn));
            // Debugging: Attach clipboard handler for the decoded query copy button. Uncomment to re-enable.
            // copyDecodedQueryBtn.addEventListener('click', () => handleCopyToClipboard(decodedQueryValue.textContent, copyDecodedQueryBtn));
            // Debugging: Attach clipboard handler for the encoded query copy button. Uncomment to re-enable.
            // copyEncodedQueryBtn.addEventListener('click', () => handleCopyToClipboard(encodedQueryValue.textContent, copyEncodedQueryBtn));

            // Populate test cases buttons dynamically
            for (const [name, query] of Object.entries(testCases)) {
                const button = document.createElement('button');
                button.textContent = name;
                // Add Pico's button classes and our custom test-case-btn class
                button.classList.add('test-case-btn');
                button.addEventListener('click', () => {
                    uiQueryInput.value = query; // Update textarea value
                    uiQuery = query; // Update internal state variable
                    hideError(); // Clear error messages
                    hideResults(); // Hide previous results
                });
                testCasesContainer.appendChild(button);
            }

            // Initial state setup
            hideError(); // Ensure error is hidden on page load
            hideResults(); // Ensure results are hidden on page load
        });
    </script>
</body>
</html>